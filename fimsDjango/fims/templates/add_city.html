{% extends 'dashboard_base.html' %}
{% load static %}
{% block title %}Add City{% endblock %}

{% block content %}
{% if messages %}
  <script>
    alert("{% for message in messages %}{{ message|escapejs }}{% if not forloop.last %}\n{% endif %}{% endfor %}");
  </script>
{% endif %}
<style>
  body { background: #f5f7fa; }
  .city-form-container {
    background: #fff;
    max-width: 420px;
    margin: 48px auto 0 auto;
    padding: 36px 38px 30px 38px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(30,40,90,0.13);
    display: flex;
    flex-direction: column;
    align-items: center;
    border: 1.5px solid #e3e8ee;
  }
  .city-form-container h2 {
    margin-bottom: 22px;
    color: #1f2a38;
    font-size: 1.7rem;
    font-weight: 400;
    letter-spacing: 1px;
    text-shadow: 0 1px 0 #f8fafc;
  }
  .form-group {
    width: 100%;
    margin-bottom: 22px;
  }
  label {
    display: block;
    margin-bottom: 8px;
    color: #2c3e50;
    font-weight: 600;
    font-size: 1.07rem;
    letter-spacing: 0.5px;
  }
  select, input[type="text"] {
    width: 100%;
    padding: 12px 15px;
    border-radius: 8px;
    border: 1.5px solid #bfc9d1;
    font-size: 1.08rem;
    transition: border 0.3s, box-shadow 0.3s;
    background: #f8fafc;
    box-shadow: 0 1px 2px rgba(30,40,90,0.03);
  }
  select:focus, input[type="text"]:focus {
    border-color: #1f2a38;
    outline: none;
    background: #fff;
    box-shadow: 0 2px 8px rgba(30,40,90,0.07);
  }
  select.input-error, input[type="text"].input-error {
    border-color: #e74c3c;
    background: #fff6f6;
  }
  .primary {
    width: 100%;
    padding: 11px 0;
    background: linear-gradient(90deg, #1f2a38, #2c3e50);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1.13rem;
    font-weight: 400;
    cursor: pointer;
    margin-top: 10px;
    transition: background 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(30,40,90,0.07);
  }
  .primary:hover {
    background: linear-gradient(90deg, #2c3e50, #1f2a38);
    box-shadow: 0 4px 16px rgba(30,40,90,0.10);
  }
  .error-message {
    color: #e74c3c;
    font-size: 1.04rem;
    margin-top: 10px;
    min-height: 22px;
    display: block;
    text-align: center;
    font-weight: 400;
  }
  @media (max-width: 600px) {
    .city-form-container {
      padding: 18px 8px 18px 8px;
    }
  }
    .back-btn{
                background-color: rgba(31, 42, 56, 0.9);

        color: white;
        padding: 0.3rem;
        border-radius: 10px;
    }
    .back-btn:hover{
        background-color: rgba(31, 42, 56, 1);
        color: white;
        padding: 0.4rem;
        border-radius: 10px;
    }
</style>
<a href="{% url 'dashboard_city' %}" class="back-btn">&larr; Back to Dashboard</a>
<div class="city-form-container">
  <h2>Add City</h2>
  <form id="addCityForm" method="post" action="" autocomplete="off">
    {% csrf_token %}
    <div class="form-group">
      <label for="state_id">State:</label>
      <select name="state_id" id="state_id">
        <option value="">Select State</option>
        {% for state in states %}
          <option value="{{ state.id }}">{{ state.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="name">City Name:</label>
      <input type="text" name="name" id="name" placeholder="Enter city name" autocomplete="off">
    </div>
    <button type="submit" class="primary">Add City</button>
    <span class="error-message">{% if error %}{{ error }}{% endif %}</span>
  </form>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function() {
      var cityUnique = false;
      var lastCheckedCity = '';
      var lastCheckedState = '';

      function checkCityUnique() {
        var stateId = $('#state_id').val();
        var cityName = $('#addCityForm input[name="name"]').val().trim();
        var errorSpan = $('#addCityForm .error-message');
        if (!stateId || !cityName) {
          cityUnique = false;
          return;
        }
        // Avoid duplicate AJAX calls for same value
        if (cityName === lastCheckedCity && stateId === lastCheckedState) return;
        lastCheckedCity = cityName;
        lastCheckedState = stateId;
        $.ajax({
          url: '{% url "check_city_name_unique" %}',
          type: 'GET',
          data: {
            state_id: stateId,
            name: cityName
          },
          success: function(response) {
            if (response.exists) {
              errorSpan.text('City name already exists in this state.');
              $('#addCityForm input[name="name"]').addClass('input-error');
              cityUnique = false;
            } else {
              errorSpan.text('');
              $('#addCityForm input[name="name"]').removeClass('input-error');
              cityUnique = true;
            }
          },
          error: function() {
            errorSpan.text('Error checking city name.');
            cityUnique = false;
          }
        });
      }

      $('#state_id, #addCityForm input[name="name"]').on('input change', function() {
        $(this).removeClass('input-error');
        $(this).closest('form').find('.error-message').text('');
        checkCityUnique();
      });

      $('#addCityForm').on('submit', function(e) {
        var valid = true;
        var state = $('#state_id');
        var city = $('#addCityForm input[name="name"]');
        var errorSpan = $(this).find('.error-message');
        errorSpan.text('');
        state.removeClass('input-error');
        city.removeClass('input-error');
        if (!state.val()) {
          errorSpan.text('State is required.');
          state.addClass('input-error');
          valid = false;
        } else if (!city.val().trim()) {
          errorSpan.text('City name is required.');
          city.addClass('input-error');
          valid = false;
        } else if (!cityUnique) {
          errorSpan.text('City name already exists in this state.');
          city.addClass('input-error');
          valid = false;
        }
        if (!valid) e.preventDefault();
      });
    });
  </script>
</div>
{% endblock %}
