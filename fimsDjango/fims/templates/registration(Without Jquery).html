{% extends 'base.html' %}
{% load static %}
{% block title %}Family Registration{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'fims/css/registration.css' %}">
{% endblock %}

{% block content %}
<p class="form-subtitle">Fill the information below to register your family.</p>

<ul id="note-head">
    <li class="note">Note:</li>
    <li class="note">Head of the Family should be registered</li>
    <li class="note">Family Head Should be 21 years or older</li>
    <li class="note">Family Members can be added at the end of the form</li>
</ul>

<form method="post" enctype="multipart/form-data" id="registrationForm">
    {% csrf_token %}

    <div id="general-errors" class="error-message"></div>

    <fieldset id="head-fieldset">
        <legend class="highlight-title">Family Head</legend>
        <table class="form-table two-column">
            <tr>
                <td>
                    <label for="head_name">First Name:</label>
                    <input type="text" id="head_name" name="head_name" placeholder="First Name" maxlength="50" value="{{ head.Name|default_if_none:'' }}">
                    <span class="error-message" id="error-head_name"></span>
                </td>
                <td>
                    <label for="head_surname">Surname:</label>
                    <input type="text" id="head_surname" name="head_surname" placeholder="Surname" maxlength="50" value="{{ head.Surname|default_if_none:'' }}">
                    <span class="error-message" id="error-head_surname"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="head_birthdate">Birthdate:</label>
                    <input type="date" id="head_birthdate" name="head_birthdate" value="{{ head.Birthdate|date:'Y-m-d'|default_if_none:'' }}">
                    <span class="error-message" id="error-head_birthdate"></span>
                </td>
                <td>
                    <label for="head_mobile">Mobile No:</label>
                    <input type="text" id="head_mobile" name="head_mobile" placeholder="Mobile No" maxlength="10" value="{{ head.MobileNo|default_if_none:'' }}">
                    <span class="error-message" id="error-head_mobile"></span>
                    <span class="error-message" id="error-head_mobile_unique" style="color:firebrick;"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="head_address">Address:</label>
                    <textarea id="head_address" name="head_address" placeholder="Address">{{ head.Address|default_if_none:'' }}</textarea>
                    <span class="error-message" id="error-head_address"></span>
                </td>
                <td>
                    <label for="head_state">State:</label>
                    <select name="head_state" id="head_state">
                        <option value="">Select State</option>
                        {% for state in states %}
                        <option value="{{ state.id }}" {% if head.State == state.name or head.State == state.id|stringformat:'s' %}selected{% endif %}>{{ state.name }}</option>
                        {% endfor %}
                    </select>
                    <span class="error-message" id="error-head_state"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="head_city">City:</label>
                    <select name="head_city" id="head_city">
                        <option value="">Select City</option>
                        {% if head.City %}
                        <option value="{{ head.City }}" selected>{{ head.City }}</option>
                        {% endif %}
                    </select>
                    <span class="error-message" id="error-head_city"></span>
                </td>
                <td>
                    <label for="head_pincode">Pincode:</label>
                    <input type="text" id="head_pincode" name="head_pincode" placeholder="Pincode" maxlength="6" value="{{ head.Pincode|default_if_none:'' }}">
                    <span class="error-message" id="error-head_pincode"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label>Marital Status:</label>
                    <label><input type="radio" name="head_marital_status" value="Married" {% if head.MaritalStatus == 'Married' %}checked{% endif %}> Married</label>
                    <label><input type="radio" name="head_marital_status" value="Unmarried" {% if head.MaritalStatus == 'Unmarried' %}checked{% endif %}> Unmarried</label>
                    <span class="error-message" id="error-head_marital_status"></span>
                </td>
                <td>
                    <label>Gender:</label>
                    <label><input type="radio" name="head_gender" value="Male" {% if head.Gender == 'Male' %}checked{% endif %}> Male</label>
                    <label><input type="radio" name="head_gender" value="Female" {% if head.Gender == 'Female' %}checked{% endif %}> Female</label>
                    <span class="error-message" id="error-head_gender"></span>
                </td>
            </tr>
            <tr id="wedding_date_row" style="display:none;">
                <td colspan="2">
                    <label for="head_wedding_date">Wedding Date:</label>
                    <input type="date" name="head_wedding_date" id="wedding_date" value="{{ head.WeddingDate|date:'Y-m-d'|default_if_none:'' }}">
                    <span class="error-message" id="error-head_wedding_date"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="head_education">Education:</label>
                    <select name="head_education" id="head_education">
                        <option value="">Select</option>
                        <option value="Graduate" {% if head.Education == 'Graduate' %}selected{% endif %}>Graduate</option>
                        <option value="Post Graduate" {% if head.Education == 'Post Graduate' %}selected{% endif %}>Post Graduate</option>
                        <option value="Diploma" {% if head.Education == 'Diploma' %}selected{% endif %}>Diploma</option>
                    </select>
                    <span class="error-message" id="error-head_education"></span>
                </td>
                <td>
                    <label for="head_photo">Upload Photo:</label>
                    <input type="file" id="head_photo" name="head_photo" accept="image/png, image/jpeg">
                    {% if head.Photo %}
                        <div class="photo-preview">Current file: {{ head.Photo.name }}</div>
                    {% endif %}
                    <span class="error-message" id="error-head_photo"></span>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <label>Hobbies:</label>
                    <div id="hobbies-section" class="hobbies-section">
                        <button type="button" class="secondary hobby-btn" onclick="addHobby('head', this)">+ Add Hobby</button>
                        {% if head.head_hobbies.all %}
                            {% for hobby in head.head_hobbies.all %}
                                <input type="text" class="hobby-input" name="head_hobbies[]" value="{{ hobby.Hobby }}" placeholder="Enter a hobby">
                            {% endfor %}
                        {% else %}
                            <input type="text" class="hobby-input" name="head_hobbies[]" placeholder="Enter a hobby">
                        {% endif %}
                    </div>
                    <span class="error-message" id="error-head_hobbies"></span>
                </td>
            </tr>
        </table>
    </fieldset>

    <div id="members-container">
        <h3 class="highlight-title">Family Members</h3>
        {% if members %}
            {% for member in members %}
                <hr style="margin: 2em 0; border-top: 2px solid #ccc;">
                <div class="member-block" style="border: 1px solid #bdbdbd; border-radius: 8px; margin-bottom: 2em; background: #f9f9f9; box-shadow: 0 2px 8px #ececec;">
                    <div class="member-block-header" style="display: flex; align-items: center; justify-content: space-between; background: #e3e3e3; border-radius: 8px 8px 0 0; padding: 0.5em 1em;">
                        <span class="member-title" style="font-weight: bold; font-size: 1.1em;">Member {{ forloop.counter }}</span>
                        <button type="button" class="close-member-btn" onclick="removeMember(this)" style="background: none; border: none; font-size: 1.5em; color: #b71c1c; cursor: pointer;">×</button>
                    </div>
                    <table class="form-table two-column" style="margin-top: 0;">
                        <tr>
                            <td>
                                <label for="member_{{ forloop.counter }}_name">First Name:</label>
                                <input type="text" name="member_{{ forloop.counter }}_name" value="{{ member.Name|default_if_none:'' }}">
                                <span class="error-message"></span>
                            </td>
                            <td>
                                <label for="member_{{ forloop.counter }}_surname">Surname:</label>
                                <input type="text" name="member_{{ forloop.counter }}_surname" value="{{ member.Surname|default_if_none:'' }}">
                                <span class="error-message"></span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label>Marital Status:</label>
                                <label><input type="radio" name="member_{{ forloop.counter }}_marital_status" value="Married" {% if member.MaritalStatus == 'Married' %}checked{% endif %}> Married</label>
                                <label><input type="radio" name="member_{{ forloop.counter }}_marital_status" value="Unmarried" {% if member.MaritalStatus == 'Unmarried' %}checked{% endif %}> Unmarried</label>
                                <span class="error-message"></span>
                            </td>
                            <td>
                                <label>Gender:</label>
                                <select name="member_{{ forloop.counter }}_gender">
                                    <option value="">Select Gender</option>
                                    <option value="Male" {% if member.Gender == 'Male' %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if member.Gender == 'Female' %}selected{% endif %}>Female</option>
                                    <option value="Other" {% if member.Gender == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                                <span class="error-message"></span>
                            </td>
                        </tr>
                        <tr id="member_{{ forloop.counter }}_wedding_date_row" style="display:none;">
                            <td colspan="2">
                                <label for="member_{{ forloop.counter }}_wedding_date">Wedding Date:</label>
                                <input type="date" name="member_{{ forloop.counter }}_wedding_date" value="{{ member.WeddingDate|date:'Y-m-d'|default_if_none:'' }}">
                                <span class="error-message"></span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="member_{{ forloop.counter }}_birthdate">Birthdate:</label>
                                <input type="date" name="member_{{ forloop.counter }}_birthdate" value="{{ member.Birthdate|date:'Y-m-d'|default_if_none:'' }}">
                                <span class="error-message"></span>
                            </td>
                            <td>
                                <label for="member_{{ forloop.counter }}_mobile">Mobile No (optional):</label>
                                <input type="text" name="member_{{ forloop.counter }}_mobile" value="{{ member.MobileNo|default_if_none:'' }}">
                                <span class="error-message"></span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="member_{{ forloop.counter }}_education">Education:</label>
                                <select name="member_{{ forloop.counter }}_education">
                                    <option value="">Select</option>
                                    <option value="Graduate" {% if member.Education == 'Graduate' %}selected{% endif %}>Graduate</option>
                                    <option value="Post Graduate">Post Graduate</option>
                                    <option value="Diploma" {% if member.Education == 'Diploma' %}selected{% endif %}>Diploma</option>
                                </select>
                                <span class="error-message"></span>
                            </td>
                            <td>
                                <label for="member_{{ forloop.counter }}_photo">Upload Photo:</label>
                                <input type="file" name="member_{{ forloop.counter }}_photo" accept="image/png, image/jpeg">
                                {% if member.Photo %}
                                    <div class="photo-preview">Current file: {{ member.Photo.name }}</div>
                                {% endif %}
                                <span class="error-message"></span>
                            </td>
                        </tr>
                         <tr>
                             <td colspan="2">
                                <label>Relationship to Head:</label>
                                <input type="text" name="member_{{ forloop.counter }}_relationship" placeholder="Relationship" maxlength="50" value="{{ member.Relationship|default_if_none:'' }}">
                                <span class="error-message"></span>
                            </td>
                        </tr>
                    </table>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <button type="button" class="secondary" id="add-member-btn" onclick="addMember()" disabled>+ Add Member</button>

    <div class="form-actions">
        <button type="submit" class="primary">Submit</button>
    </div>
</form>

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let memberIndex = {{ members|length|default:0 }};

    function showError(element, message) {
        let errorSpan;
        if (element.nextElementSibling && element.nextElementSibling.classList.contains('error-message')) {
            errorSpan = element.nextElementSibling;
        } else {
            const parentTd = element.closest('td');
            if (parentTd) {
                errorSpan = parentTd.querySelector('.error-message');
            }
        }
        if (errorSpan) {
            errorSpan.textContent = `* ${message}`;
        }
    }
    
    function clearErrors() {
        document.querySelectorAll(".error-message").forEach(el => el.textContent = "");
    }

    // New validation function for Family Head
    function validateHead(showErrors = false) {
        let valid = true;
        if (showErrors) clearErrors();

        const headFields = [
            { id: "head_name", msg: "First name is required." },
            { id: "head_surname", msg: "Surname is required." },
            { id: "head_address", msg: "Address is required." },
            { id: "head_state", msg: "State is required." },
            { id: "head_city", msg: "City is required." },
            { id: "head_education", msg: "Education is required." }
        ];

        headFields.forEach(field => {
            const input = document.getElementById(field.id);
            if (!input.value.trim()) {
                if (showErrors) showError(input, field.msg);
                valid = false;
            }
        });

        const birthdateInput = document.getElementById("head_birthdate");
        if (!birthdateInput.value) {
            if (showErrors) showError(birthdateInput, "Birthdate is required.");
            valid = false;
        } else {
            const birthdate = new Date(birthdateInput.value);
            const age = Math.floor((Date.now() - birthdate.getTime()) / (365.25 * 24 * 60 * 60 * 1000));
            if (age < 21) {
                if (showErrors) showError(birthdateInput, "Head must be 21+ years.");
                valid = false;
            }
        }

        const mobileInput = document.getElementById("head_mobile");
        if (!/^\d{10}$/.test(mobileInput.value.trim())) {
            if (showErrors) showError(mobileInput, "Enter a valid 10-digit mobile number.");
            valid = false;
        }

        const pincodeInput = document.getElementById("head_pincode");
        if (!/^\d{6}$/.test(pincodeInput.value.trim())) {
            if (showErrors) showError(pincodeInput, "Enter a valid 6-digit pincode.");
            valid = false;
        }

        const maritalStatus = document.querySelector("input[name='head_marital_status']:checked");
        if (!maritalStatus) {
            if (showErrors) document.getElementById("error-head_marital_status").textContent = "* Select marital status.";
            valid = false;
        } else if (maritalStatus.value === "Married" && !document.getElementById("wedding_date").value) {
            if (showErrors) document.getElementById("error-head_wedding_date").textContent = "* Wedding date required.";
            valid = false;
        }

        const gender = document.querySelector("input[name='head_gender']:checked");
        if (!gender) {
            if (showErrors) document.getElementById("error-head_gender").textContent = "* Select gender.";
            valid = false;
        }

        const hobbiesInputs = document.querySelectorAll("input[name='head_hobbies[]']");
        let hasHobby = Array.from(hobbiesInputs).some(h => h.value.trim());
        if (!hasHobby) {
            if (showErrors) document.getElementById("error-head_hobbies").textContent = "* Enter at least one hobby.";
            valid = false;
        }
        
        const photoInput = document.getElementById("head_photo");
        const photoPreview = document.querySelector('#head_photo + .photo-preview');
        if (!photoInput.files[0] && !photoPreview) {
            if (showErrors) document.getElementById("error-head_photo").textContent = "* Photo is required.";
            valid = false;
        } else if (photoInput.files[0]) {
            const file = photoInput.files[0];
            if (!["image/jpeg", "image/png"].includes(file.type) || file.size > 2 * 1024 * 1024) {
                if (showErrors) document.getElementById("error-head_photo").textContent = "* Only JPG/PNG ≤2MB allowed.";
                valid = false;
            }
        }
        
        return valid;
    }
    
    // New validation function for individual members
    function validateMember(memberBlock, showErrors = false) {
        let valid = true;
        
        const index = memberBlock.querySelector('input[name*="_name"]').name.match(/member_(\d+)_name/)[1];

        const memberFields = [
            { name: `member_${index}_name`, msg: "First name is required." },
            { name: `member_${index}_surname`, msg: "Surname is required." },
            { name: `member_${index}_relationship`, msg: "Relationship is required." },
            { name: `member_${index}_birthdate`, msg: "Birthdate is required." },
            { name: `member_${index}_education`, msg: "Education is required." }
        ];

        memberFields.forEach(field => {
            const input = memberBlock.querySelector(`[name="${field.name}"]`);
            if (input && !input.value.trim()) {
                if (showErrors) showError(input, field.msg);
                valid = false;
            }
        });

        const memberMaritalStatus = memberBlock.querySelector(`input[name="member_${index}_marital_status"]:checked`);
        if (!memberMaritalStatus) {
            const maritalStatusLabel = memberBlock.querySelector('td:has(input[name="member_' + index + '_marital_status"])');
            if (showErrors) showError(maritalStatusLabel, "Select marital status.");
            valid = false;
        } else if (memberMaritalStatus.value === 'Married') {
            const weddingDateInput = memberBlock.querySelector(`input[name="member_${index}_wedding_date"]`);
            if (!weddingDateInput.value) {
                if (showErrors) showError(weddingDateInput, "Wedding date is required.");
                valid = false;
            }
        }
        
        const memberGender = memberBlock.querySelector(`select[name="member_${index}_gender"]`);
        if (!memberGender.value) {
            if (showErrors) showError(memberGender, "Select gender.");
            valid = false;
        }
        
        const memberPhoto = memberBlock.querySelector(`input[name="member_${index}_photo"]`);
        const memberPhotoPreview = memberBlock.querySelector('.photo-preview');
        if (!memberPhoto.files[0] && !memberPhotoPreview) {
            if (showErrors) showError(memberPhoto, "Photo is required.");
            valid = false;
        } else if (memberPhoto.files[0]) {
            const file = memberPhoto.files[0];
            if (!["image/jpeg", "image/png"].includes(file.type) || file.size > 2 * 1024 * 1024) {
                if (showErrors) showError(memberPhoto, "Only JPG/PNG ≤2MB allowed.");
                valid = false;
            }
        }
        
        return valid;
    }

    // Main form validation function
    function validateForm(event) {
        event.preventDefault();
        clearErrors();
        
        let valid = validateHead(true);
        
        const memberBlocks = document.querySelectorAll(".member-block");
        memberBlocks.forEach(block => {
            if (!validateMember(block, true)) {
                valid = false;
            }
        });

        if (!valid) {
            const firstError = document.querySelector(".error-message:not(:empty)");
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }
        
        const form = document.getElementById('registrationForm');
        const formData = new FormData(form);

        $.ajax({
            url: form.action,
            method: form.method,
            data: formData,
            processData: false,
            contentType: false,
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    window.location.reload(); 
                } else {
                    clearErrors();
                    response.errors.forEach(error => {
                        const errorSpan = document.getElementById('general-errors');
                        if (errorSpan) {
                            errorSpan.textContent = `* ${error}`;
                        } else {
                            alert(error);
                        }
                    });
                    const firstError = document.querySelector(".error-message:not(:empty)");
                    if (firstError) {
                         firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = 'An error occurred. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.errors) {
                    errorMessage = xhr.responseJSON.errors.join('\n');
                }
                alert(errorMessage);
            }
        });
    }
    
    // Check form validity and update "Add Member" button state
    function checkFormValidity() {
        const isValid = validateHead();
        const addMemberBtn = document.getElementById('add-member-btn');
        const headFieldset = document.getElementById('head-fieldset');
        
        if (isValid) {
            addMemberBtn.disabled = false;
            headFieldset.style.border = '2px solid green';
        } else {
            addMemberBtn.disabled = true;
            headFieldset.style.border = '2px solid red';
        }
    }

    // Attach real-time validation to all head form fields
    document.querySelectorAll('#head-fieldset input, #head-fieldset select, #head-fieldset textarea').forEach(input => {
        input.addEventListener('change', checkFormValidity);
        input.addEventListener('blur', checkFormValidity);
    });

    // Attach the main event listener to the form
    document.getElementById("registrationForm").addEventListener("submit", validateForm);

    $(document).ready(function() {
        $("#head_state").change(function() {
            var stateId = $(this).val();
            $("#head_city").empty().append('<option value="">Select City</option>');
            if (stateId) {
                $.ajax({
                    url: "/city/",
                    data: { "state_id": stateId },
                    success: function(data) {
                        $.each(data, function(index, city) {
                            $("#head_city").append('<option value="' + city.id + '">' + city.name + '</option>');
                        });
                    }
                });
            }
        });

        $('input[name="head_marital_status"]').change(function() {
            $('#wedding_date_row').toggle(this.value === 'Married');
            checkFormValidity();
        });

        $(document).on('change', 'input[name^="member_"][name$="_marital_status"]', function() {
            const index = $(this).attr('name').match(/member_(\d+)_marital_status/)[1];
            $(`#member_${index}_wedding_date_row`).toggle(this.value === 'Married');
        });

        $('#head_mobile').on('blur', function() {
            var mobile = $(this).val().trim();
            if (mobile.length === 10 && /^\d{10}$/.test(mobile)) {
                $.get('/fims/check_head_mobile_unique/', { mobile: mobile }, function(data) {
                    if (data.exists) {
                        $('#error-head_mobile_unique').text('This mobile number is already registered.');
                        checkFormValidity();
                    } else {
                        $('#error-head_mobile_unique').text('');
                        checkFormValidity();
                    }
                });
            } else {
                $('#error-head_mobile_unique').text('');
                checkFormValidity();
            }
        });
        
        // Initial check on page load in case of saved data
        checkFormValidity();
    });

    window.addHobby = function(type, btn) {
        let section;
        if (type === 'head') {
            section = document.getElementById("hobbies-section");
        } else {
            section = btn.closest('.hobbies-section');
        }
        const input = document.createElement("input");
        input.type = "text";
        const index = btn.closest('.member-block') ? btn.closest('.member-block').querySelector('input[name*="_name"]').name.match(/member_(\d+)_name/)[1] : null;
        input.name = type === 'head' ? 'head_hobbies[]' : `member_${index}_hobbies[]`;
        input.placeholder = "Enter a hobby";
        input.classList.add("hobby-input");
        section.insertBefore(input, btn);
        checkFormValidity(); // Check validity after adding hobby field
    };
    
    window.addMember = function() {
        if (document.getElementById('add-member-btn').disabled) {
            validateHead(true); // Show errors if user tries to bypass
            return;
        }

        memberIndex++;
        const container = document.getElementById("members-container");
        const newMemberBlock = document.createElement("div");
        newMemberBlock.className = "member-block";
        newMemberBlock.style.border = "1px solid #bdbdbd";
        newMemberBlock.style.borderRadius = "8px";
        newMemberBlock.style.marginBottom = "2em";
        newMemberBlock.style.background = "#f9f9f9";
        newMemberBlock.style.boxShadow = "0 2px 8px #ececec";
        newMemberBlock.innerHTML = `
            <hr style="margin: 2em 0; border-top: 2px solid #ccc;">
            <div class="member-block-header" style="display: flex; align-items: center; justify-content: space-between; background: #e3e3e3; border-radius: 8px 8px 0 0; padding: 0.5em 1em;">
                <span class="member-title" style="font-weight: bold; font-size: 1.1em;">Member ${memberIndex}</span>
                <button type="button" class="close-member-btn" onclick="removeMember(this)" style="background: none; border: none; font-size: 1.5em; color: #b71c1c; cursor: pointer;">×</button>
            </div>
            <table class="form-table two-column" style="margin-top: 0;">
                <tr>
                    <td>
                        <label>First Name:</label>
                        <input type="text" name="member_${memberIndex}_name" placeholder="First Name" maxlength="50">
                        <span class="error-message"></span>
                    </td>
                    <td>
                        <label>Surname:</label>
                        <input type="text" name="member_${memberIndex}_surname" placeholder="Surname" maxlength="50">
                        <span class="error-message"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Marital Status:</label>
                        <label><input type="radio" name="member_${memberIndex}_marital_status" value="Married"> Married</label>
                        <label><input type="radio" name="member_${memberIndex}_marital_status" value="Unmarried"> Unmarried</label>
                        <span class="error-message"></span>
                    </td>
                    <td>
                        <label>Gender:</label>
                        <select name="member_${memberIndex}_gender">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                        <span class="error-message"></span>
                    </td>
                </tr>
                <tr id="member_${memberIndex}_wedding_date_row" style="display:none;">
                    <td colspan="2">
                        <label>Wedding Date:</label>
                        <input type="date" name="member_${memberIndex}_wedding_date">
                        <span class="error-message"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Birthdate:</label>
                        <input type="date" name="member_${memberIndex}_birthdate">
                        <span class="error-message"></span>
                    </td>
                    <td>
                        <label>Mobile No (optional):</label>
                        <input type="text" name="member_${memberIndex}_mobile" maxlength="10">
                        <span class="error-message"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Education:</label>
                        <select name="member_${memberIndex}_education">
                            <option value="">Select</option>
                            <option value="Graduate">Graduate</option>
                            <option value="Post Graduate">Post Graduate</option>
                            <option value="Diploma">Diploma</option>
                        </select>
                        <span class="error-message"></span>
                    </td>
                    <td>
                        <label>Upload Photo:</label>
                        <input type="file" name="member_${memberIndex}_photo" accept="image/png, image/jpeg">
                        <span class="error-message"></span>
                    </td>
                </tr>
                 <tr>
                    <td colspan="2">
                        <label>Relationship to Head:</label>
                        <input type="text" name="member_${memberIndex}_relationship" placeholder="Relationship" maxlength="50">
                        <span class="error-message"></span>
                    </td>
                </tr>
            </table>
        `;
        container.appendChild(newMemberBlock);
        
        // Add real-time event listeners for the new member's form fields
        newMemberBlock.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('change', () => validateMember(newMemberBlock, true));
            input.addEventListener('blur', () => validateMember(newMemberBlock, true));
        });
        
        // Add event listener for the new member's marital status
        newMemberBlock.querySelectorAll(`input[name="member_${memberIndex}_marital_status"]`).forEach(radio => {
            radio.addEventListener('change', function() {
                const weddingDateRow = newMemberBlock.querySelector(`#member_${memberIndex}_wedding_date_row`);
                weddingDateRow.style.display = this.value === 'Married' ? '' : 'none';
                validateMember(newMemberBlock, true);
            });
        });
    };

    window.removeMember = function(btn) {
        $(btn).closest('.member-block').remove();
        reIndexMembers();
    };

    function reIndexMembers() {
        const memberBlocks = document.querySelectorAll(".member-block");
        memberIndex = 0;
        memberBlocks.forEach((block, index) => {
            memberIndex = index + 1;
            block.querySelector('.member-title').textContent = `Member ${memberIndex}`;
            
            const inputs = block.querySelectorAll('[name]');
            inputs.forEach(input => {
                const name = input.name;
                const newName = name.replace(/member_\d+_/g, `member_${memberIndex}_`);
                input.name = newName;
                input.id = newName;
                
                const label = block.querySelector(`label[for="${name}"]`);
                if (label) {
                    label.setAttribute('for', newName);
                }
            });
            const weddingRow = block.querySelector('[id^="member_"][id$="_wedding_date_row"]');
            if (weddingRow) {
                weddingRow.id = `member_${memberIndex}_wedding_date_row`;
            }
        });
    }
</script>
{% endblock %}
{% endblock %}