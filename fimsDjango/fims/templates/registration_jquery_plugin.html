{% extends 'base.html' %}
{% load static %}
{% block title %}Family Registration{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'fims/css/registration.css' %}">
<style>
    /* Styling for jQuery Validation errors to match the existing layout */
    .error {
        color: firebrick;
        font-size: 0.9em;
        display: block; /* Ensure the error messages are block-level */
    }
</style>
{% endblock %}

{% block content %}
<p class="form-subtitle">Fill the information below to register your family.</p>

<ul id="note-head">
    <li class="note">Note:</li>
    <li class="note">Head of the Family should be registered</li>
    <li class="note">Family Head Should be 21 years or older</li>
    <li class="note">Family Members can be added at the end of the form</li>
</ul>

<form method="post" enctype="multipart/form-data" id="registrationForm">
    {% csrf_token %}

    <div id="general-errors" class="error-message"></div>

    <fieldset id="head-fieldset">
        <legend class="highlight-title">Family Head</legend>
        <table class="form-table two-column">
            <tr>
                <td>
                    <label for="head_name">First Name:</label>
                    <input type="text" id="head_name" name="head_name" placeholder="First Name" maxlength="50" value="{{ head.Name|default_if_none:'' }}">
                    <span class="error-message" id="error-head_name"></span> 
                </td>
                <td>
                    <label for="head_surname">Surname:</label>
                    <input type="text" id="head_surname" name="head_surname" placeholder="Surname" maxlength="50" value="{{ head.Surname|default_if_none:'' }}">
                    <span class="error-message" id="error-head_surname"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="head_birthdate">Birthdate:</label>
                    <input type="date" id="head_birthdate" name="head_birthdate" value="{{ head.Birthdate|date:'Y-m-d'|default_if_none:'' }}">
                    <span class="error-message" id="error-head_birthdate"></span>
                </td>
                <td>
                    <label for="head_mobile">Mobile No:</label>
                    <input type="text" id="head_mobile" name="head_mobile" placeholder="Mobile No" maxlength="10" value="{{ head.MobileNo|default_if_none:'' }}">
                    <span class="error-message" id="error-head_mobile"></span>
                    <span class="error-message" id="error-head_mobile_unique" style="color:firebrick;"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="head_address">Address:</label>
                    <textarea id="head_address" name="head_address" placeholder="Address">{{ head.Address|default_if_none:'' }}</textarea>
                    <span class="error-message" id="error-head_address"></span>
                </td>
                <td>
                    <label for="head_state">State:</label>
                    <select name="head_state" id="head_state">
                        <option value="">Select State</option>
                        {% for state in states %}
                        <option value="{{ state.id }}" {% if head.State == state.name or head.State == state.id|stringformat:'s' %}selected{% endif %}>{{ state.name }}</option>
                        {% endfor %}
                    </select>
                    <span class="error-message" id="error-head_state"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="head_city">City:</label>
                    <select name="head_city" id="head_city">
                        <option value="">Select City</option>
                        {% if head.City %}
                        <option value="{{ head.City }}" selected>{{ head.City }}</option>
                        {% endif %}
                    </select>
                    <span class="error-message" id="error-head_city"></span>
                </td>
                <td>
                    <label for="head_pincode">Pincode:</label>
                    <input type="text" id="head_pincode" name="head_pincode" placeholder="Pincode" maxlength="6" value="{{ head.Pincode|default_if_none:'' }}">
                    <span class="error-message" id="error-head_pincode"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label>Marital Status:</label>
                    <div id="head_marital_status_group">
                        <label><input type="radio" name="head_marital_status" value="Married" {% if head.MaritalStatus == 'Married' %}checked{% endif %}> Married</label>
                        <label><input type="radio" name="head_marital_status" value="Unmarried" {% if head.MaritalStatus == 'Unmarried' %}checked{% endif %}> Unmarried</label>
                    </div>
                    <span class="error-message" id="error-head_marital_status"></span>
                </td>
                <td>
                    <label>Gender:</label>
                    <div id="head_gender_group">
                        <label><input type="radio" name="head_gender" value="Male" {% if head.Gender == 'Male' %}checked{% endif %}> Male</label>
                        <label><input type="radio" name="head_gender" value="Female" {% if head.Gender == 'Female' %}checked{% endif %}> Female</label>
                    </div>
                    <span class="error-message" id="error-head_gender"></span>
                </td>
            </tr>
            <tr id="wedding_date_row" style="display:{% if head.MaritalStatus == 'Married' %}table-row{% else %}none{% endif %};">
                <td colspan="2">
                    <label for="head_wedding_date">Wedding Date:</label>
                    <input type="date" name="head_wedding_date" id="head_wedding_date" value="{{ head.WeddingDate|date:'Y-m-d'|default_if_none:'' }}">
                    <span class="error-message" id="error-head_wedding_date"></span>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="head_education">Education:</label>
                    <select name="head_education" id="head_education">
                        <option value="">Select</option>
                        <option value="Graduate" {% if head.Education == 'Graduate' %}selected{% endif %}>Graduate</option>
                        <option value="Post Graduate" {% if head.Education == 'Post Graduate' %}selected{% endif %}>Post Graduate</option>
                        <option value="Diploma" {% if head.Education == 'Diploma' %}selected{% endif %}>Diploma</option>
                    </select>
                    <span class="error-message" id="error-head_education"></span>
                </td>
                <td>
                    <label for="head_photo">Upload Photo:</label>
                    <input type="file" id="head_photo" name="head_photo" accept="image/png, image/jpeg">
                    {% if head.Photo %}
                        <div class="photo-preview">Current file: {{ head.Photo.name }}</div>
                    {% endif %}
                    <span class="error-message" id="error-head_photo"></span>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <label>Hobbies:</label>
                    <div id="hobbies-section" class="hobbies-section">
                        <input type="hidden" name="head_hobbies[]" value="">
                        {% if head.head_hobbies.all %}
                            {% for hobby in head.head_hobbies.all %}
                                <input type="text" class="hobby-input" name="head_hobbies[]" value="{{ hobby.Hobby }}" placeholder="Enter a hobby">
                            {% endfor %}
                        {% else %}
                            <input type="text" class="hobby-input" name="head_hobbies[]" placeholder="Enter a hobby">
                        {% endif %}
                        <button type="button" class="secondary hobby-btn" onclick="addHobby('head', this)">+ Add Hobby</button>
                    </div>
                    <span class="error-message" id="error-head_hobbies"></span>
                </td>
            </tr>
        </table>
    </fieldset>

    <div id="members-container">
        <h3 class="highlight-title">Family Members</h3>
        {% if members %}
            {% for member in members %}
                <hr style="margin: 2em 0; border-top: 2px solid #ccc;">
                <div class="member-block" style="border: 1px solid #bdbdbd; border-radius: 8px; margin-bottom: 2em; background: #f9f9f9; box-shadow: 0 2px 8px #ececec;" data-member-index="{{ forloop.counter }}">
                    <div class="member-block-header" style="display: flex; align-items: center; justify-content: space-between; background: #e3e3e3; border-radius: 8px 8px 0 0; padding: 0.5em 1em;">
                        <span class="member-title" style="font-weight: bold; font-size: 1.1em;">Member {{ forloop.counter }}</span>
                        <button type="button" class="close-member-btn" onclick="removeMember(this)" style="background: none; border: none; font-size: 1.5em; color: #b71c1c; cursor: pointer;">×</button>
                    </div>
                    <table class="form-table two-column" style="margin-top: 0;">
                        <tr>
                            <td>
                                <label for="member_{{ forloop.counter }}_name">First Name:</label>
                                <input type="text" name="member_{{ forloop.counter }}_name" value="{{ member.Name|default_if_none:'' }}" maxlength="50">
                                <span class="error-message" id="error-member_{{ forloop.counter }}_name"></span>
                            </td>
                            <td>
                                <label for="member_{{ forloop.counter }}_surname">Surname:</label>
                                <input type="text" name="member_{{ forloop.counter }}_surname" value="{{ member.Surname|default_if_none:'' }}" maxlength="50">
                                <span class="error-message" id="error-member_{{ forloop.counter }}_surname"></span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label>Marital Status:</label>
                                <div id="member_{{ forloop.counter }}_marital_status_group">
                                    <label><input type="radio" name="member_{{ forloop.counter }}_marital_status" value="Married" {% if member.MaritalStatus == 'Married' %}checked{% endif %}> Married</label>
                                    <label><input type="radio" name="member_{{ forloop.counter }}_marital_status" value="Unmarried" {% if member.MaritalStatus == 'Unmarried' %}checked{% endif %}> Unmarried</label>
                                </div>
                                <span class="error-message" id="error-member_{{ forloop.counter }}_marital_status"></span>
                            </td>
                            <td>
                                <label>Gender:</label>
                                <select name="member_{{ forloop.counter }}_gender">
                                    <option value="">Select Gender</option>
                                    <option value="Male" {% if member.Gender == 'Male' %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if member.Gender == 'Female' %}selected{% endif %}>Female</option>
                                    <option value="Other" {% if member.Gender == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                                <span class="error-message" id="error-member_{{ forloop.counter }}_gender"></span>
                            </td>
                        </tr>
                        <tr id="member_{{ forloop.counter }}_wedding_date_row" style="display:{% if member.MaritalStatus == 'Married' %}table-row{% else %}none{% endif %};">
                            <td colspan="2">
                                <label for="member_{{ forloop.counter }}_wedding_date">Wedding Date:</label>
                                <input type="date" name="member_{{ forloop.counter }}_wedding_date" value="{{ member.WeddingDate|date:'Y-m-d'|default_if_none:'' }}">
                                <span class="error-message" id="error-member_{{ forloop.counter }}_wedding_date"></span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="member_{{ forloop.counter }}_birthdate">Birthdate:</label>
                                <input type="date" name="member_{{ forloop.counter }}_birthdate" value="{{ member.Birthdate|date:'Y-m-d'|default_if_none:'' }}">
                                <span class="error-message" id="error-member_{{ forloop.counter }}_birthdate"></span>
                            </td>
                            <td>
                                <label for="member_{{ forloop.counter }}_mobile">Mobile No (optional):</label>
                                <input type="text" name="member_{{ forloop.counter }}_mobile" value="{{ member.MobileNo|default_if_none:'' }}" maxlength="10">
                                <span class="error-message" id="error-member_{{ forloop.counter }}_mobile"></span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="member_{{ forloop.counter }}_education">Education:</label>
                                <select name="member_{{ forloop.counter }}_education">
                                    <option value="">Select</option>
                                    <option value="Graduate" {% if member.Education == 'Graduate' %}selected{% endif %}>Graduate</option>
                                    <option value="Post Graduate">Post Graduate</option>
                                    <option value="Diploma">Diploma</option>
                                </select>
                                <span class="error-message" id="error-member_{{ forloop.counter }}_education"></span>
                            </td>
                            <td>
                                <label for="member_{{ forloop.counter }}_photo">Upload Photo:</label>
                                <input type="file" name="member_{{ forloop.counter }}_photo" accept="image/png, image/jpeg">
                                {% if member.Photo %}
                                    <div class="photo-preview">Current file: {{ member.Photo.name }}</div>
                                {% endif %}
                                <span class="error-message" id="error-member_{{ forloop.counter }}_photo"></span>
                            </td>
                        </tr>
                         <tr>
                             <td colspan="2">
                                <label>Relationship to Head:</label>
                                <select name="member_{{ forloop.counter }}_relationship">
                                    <option value="">Select</option>
                                    <option value="Father" {% if member.Relationship == 'Father' %}selected{% endif %}>Father</option>
                                    <option value="Mother" {% if member.Relationship == 'Mother' %}selected{% endif %}>Mother</option>
                                    <option value="Brother" {% if member.Relationship == 'Brother' %}selected{% endif %}>Brother</option>
                                    <option value="Sister" {% if member.Relationship == 'Sister' %}selected{% endif %}>Sister</option>
                                    <option value="Son" {% if member.Relationship == 'Son' %}selected{% endif %}>Son</option>
                                    <option value="Daughter" {% if member.Relationship == 'Daughter' %}selected{% endif %}>Daughter</option>
                                    <option value="Uncle" {% if member.Relationship == 'Uncle' %}selected{% endif %}>Uncle</option>
                                    <option value="Aunt" {% if member.Relationship == 'Aunt' %}selected{% endif %}>Aunt</option>
                                    <option value="Other" {% if member.Relationship == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                                <span class="error-message" id="error-member_{{ forloop.counter }}_relationship"></span>
                            </td>
                        </tr>
                    </table>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <button type="button" class="secondary" id="add-member-btn" onclick="addMember()">+ Add Member</button>

    <div class="form-actions">
        <button type="submit" class="primary" id="submitBtn">Submit</button>
    </div>
</form>

{% block extra_js %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/additional-methods.min.js"></script>
<script>
    let memberIndex = {{ members|length|default:0 }};

    // --- START: jQuery Validation Custom Methods ---

    // 1. Custom Method: Check Age (Head must be 21+)
    $.validator.addMethod("ageCheck", function(value, element, minAge) {
        if (!value) return true; // Let 'required' handle empty
        const birthdate = new Date(value);
        const age = Math.floor((Date.now() - birthdate.getTime()) / (365.25 * 24 * 60 * 60 * 1000));
        return age >= minAge;
    }, "Family Head must be {0} years or older.");

    // 2. Custom Method: Letters Only (No digit, space, or special character)
    $.validator.addMethod("lettersonly", function(value, element) {
        return this.optional(element) || /^[a-zA-Z]+$/.test(value);
    }, "Only letters (A-Z, a-z) are allowed.");

    // 3. Custom Method: At least one hobby is required
    $.validator.addMethod("atLeastOneHobby", function(value, element) {
        // Find all hobby inputs within the section
        const section = $(element).closest('.hobbies-section');
        // Check if any visible hobby input (excluding the hidden one used for array field existence) has a non-empty value
        return section.find('input[type="text"][name="head_hobbies[]"], input[type="text"][name*="_hobbies[]"]').filter(function() {
            return $.trim($(this).val()).length > 0;
        }).length > 0;
    }, "Enter at least one hobby.");

    // 4. Function to apply rules to Member fields dynamically
    function applyMemberRules(memberBlock, index) {
        const rules = {
            [`member_${index}_name`]: {
                required: true,
                lettersonly: true,
                minlength: 3,
                maxlength: 50
            },
            [`member_${index}_surname`]: {
                required: true,
                lettersonly: true,
                minlength: 3,
                maxlength: 50
            },
            [`member_${index}_marital_status`]: {
                required: true
            },
            [`member_${index}_gender`]: {
                required: true
            },
            [`member_${index}_wedding_date`]: {
                required: {
                    depends: function(element) {
                        // Check the corresponding radio button's value
                        return $(memberBlock).find(`input[name="member_${index}_marital_status"]:checked`).val() === 'Married';
                    }
                }
            },
            [`member_${index}_birthdate`]: {
                required: true
            },
            [`member_${index}_mobile`]: {
                digits: true,
                minlength: 10,
                maxlength: 10
            },
            [`member_${index}_education`]: {
                required: true
            },
            [`member_${index}_photo`]: {
                // Check if a file is selected OR if a photo preview exists (for existing members)
                required: !$(memberBlock).find('.photo-preview').length,
                extension: "png|jpg|jpeg",
                maxsize: 2097152 // 2MB in bytes
            },
            [`member_${index}_relationship`]: {
                required: true
            }
        };

        const messages = {
            [`member_${index}_name`]: {
                required: "* First name is required.",
                lettersonly: "* Only letters allowed.",
                minlength: "* Must be at least 3 chars."
            },
            [`member_${index}_surname`]: {
                required: "* Surname is required.",
                lettersonly: "* Only letters allowed.",
                minlength: "* Must be at least 3 chars."
            },
            [`member_${index}_marital_status`]: "* Select marital status.",
            [`member_${index}_gender`]: "* Select gender.",
            [`member_${index}_wedding_date`]: "* Wedding date required.",
            [`member_${index}_birthdate`]: "* Birthdate is required.",
            [`member_${index}_mobile`]: {
                digits: "* Must be digits.",
                minlength: "* 10-digit number required.",
                maxlength: "* 10-digit number required."
            },
            [`member_${index}_education`]: "* Education is required.",
            [`member_${index}_photo`]: {
                required: "* Photo is required.",
                extension: "* Only JPG/PNG allowed."
            },
            [`member_${index}_relationship`]: "* Relationship is required."
        };

        // Apply rules and messages to all relevant inputs in the block
        $.each(rules, function(name, rule) {
            const input = $(memberBlock).find(`[name="${name}"]`);
            if (input.length) {
                // Remove existing rules before adding to prevent duplicates after re-indexing
                input.rules("remove"); 
                input.rules("add", rule);
                input.data("messages", {
                    ...input.data("messages"),
                    ...messages[name]
                });
            }
        });
    }

    // --- END: jQuery Validation Custom Methods ---


    $(document).ready(function() {
        const validator = jQuery('#registrationForm').validate({
            // 5. Head Field Rules
            rules: {
                head_name: {
                    required: true,
                    lettersonly: true,
                    minlength: 3,
                    maxlength: 50
                },
                head_surname: {
                    required: true,
                    lettersonly: true,
                    minlength: 3,
                    maxlength: 50
                },
                head_birthdate: {
                    required: true,
                    ageCheck: 21 // Custom 21+ age check
                },
                head_mobile: {
                    required: true,
                    digits: true,
                    minlength: 10,
                    maxlength: 10
                },
                head_address: "required",
                head_state: "required",
                head_city: "required",
                head_pincode: {
                    required: true,
                    digits: true,
                    minlength: 6,
                    maxlength: 6
                },
                head_marital_status: "required",
                head_gender: "required",
                head_education: "required",
                head_wedding_date: {
                    required: {
                        // Conditional requirement: only required if Married is checked
                        depends: function(element) {
                            return $('input[name="head_marital_status"]:checked').val() === 'Married';
                        }
                    }
                },
                head_photo: {
                    // Conditional required: only required if no photo preview exists
                    required: !$('#head_photo').nextAll('.photo-preview').length,
                    extension: "png|jpg|jpeg",
                    maxsize: 2097152 // 2MB
                },
                "head_hobbies[]": {
                    atLeastOneHobby: true
                }
            },

            // 6. Custom Messages
            messages: {
                head_name: {
                    required: "* First name is required.",
                    lettersonly: "* Only letters allowed.",
                    minlength: "* Must be at least 3 chars."
                },
                head_surname: {
                    required: "* Surname is required.",
                    lettersonly: "* Only letters allowed.",
                    minlength: "* Must be at least 3 chars."
                },
                head_birthdate: {
                    required: "* Birthdate is required."
                },
                head_mobile: {
                    required: "* Mobile number is required.",
                    digits: "* Enter a valid 10-digit number.",
                    minlength: "* Enter a valid 10-digit number.",
                    maxlength: "* Enter a valid 10-digit number."
                },
                head_address: "* Address is required.",
                head_state: "* State is required.",
                head_city: "* City is required.",
                head_pincode: {
                    required: "* Pincode is required.",
                    digits: "* Enter a valid 6-digit pincode.",
                    minlength: "* Enter a valid 6-digit pincode.",
                    maxlength: "* Enter a valid 6-digit pincode."
                },
                head_marital_status: "* Select marital status.",
                head_gender: "* Select gender.",
                head_education: "* Education is required.",
                head_wedding_date: "* Wedding date is required.",
                head_photo: {
                    required: "* Photo is required.",
                    extension: "* Only JPG/PNG allowed."
                }
            },
            
            // 7. Error Placement
            errorPlacement: function(error, element) {
                // Determine where to place the error based on the field type/name
                const name = element.attr("name");

                if (name === "head_marital_status") {
                    error.appendTo("#error-head_marital_status");
                } else if (name === "head_gender") {
                    error.appendTo("#error-head_gender");
                } else if (name === "head_hobbies[]") {
                    error.appendTo("#error-head_hobbies");
                } else if (name && name.startsWith("member_")) {
                    // For all member fields, find the corresponding error span
                    const errorSpanId = `#error-${name}`;
                    if ($(errorSpanId).length) {
                        error.appendTo($(errorSpanId).parent());
                    } else {
                        error.insertAfter(element);
                    }
                } else {
                    // For all other head fields, append to the specific error span ID
                    const errorId = "#error-" + element.attr("id");
                    if ($(errorId).length) {
                         error.appendTo($(errorId).parent());
                    } else {
                        // Fallback
                        error.insertAfter(element);
                    }
                }
            },

            // 8. Corrected Submission Handler with robust error handling for JSON responses
            submitHandler: function(form) {
                const formData = new FormData(form);
                
                // 1. Clear previous server-side errors
                $('.error-message').text(''); 
                
                // Add a visual indicator
                const $submitBtn = $('#submitBtn');
                const originalText = $submitBtn.text();
                $submitBtn.prop('disabled', true).text('Submitting...');

                $.ajax({
                    url: form.action,
                    method: form.method,
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {'X-Requested-With': 'XMLHttpRequest'},
                    
                    success: function(response) {
                        $submitBtn.prop('disabled', false).text(originalText);
                        
                        // This block handles successful 200 OK or failure with success: false (less common but handled)
                        if (response.success) {
                            alert(response.message);
                            window.location.reload(); 
                        } else {
                            let generalErrorSpan = document.getElementById('general-errors');
                            
                            // Iterate through the structured error list
                            if (response.errors && response.errors.length > 0) {
                                response.errors.forEach(error => {
                                    const fieldName = error.field;
                                    const message = `* ${error.message}`;
                                    
                                    const $errorSpan = $(`#error-${fieldName}`);
                                    if ($errorSpan.length) {
                                        $errorSpan.text(message);
                                    } else if (generalErrorSpan) {
                                        generalErrorSpan.textContent += message + ' ';
                                    }
                                });
                            }
                        }
                    },
                    
                    error: function(xhr, status, error) {
                        // 2. THIS IS THE KEY FIX: Handle 400 Bad Request response from Django
                        $submitBtn.prop('disabled', false).text(originalText);
                        let generalErrorSpan = document.getElementById('general-errors');
                        
                        // Clear previous general errors
                        if (generalErrorSpan) generalErrorSpan.textContent = '';
                        
                        if (xhr.status === 400 && xhr.responseJSON) {
                            const response = xhr.responseJSON;
                            
                            if (response.errors && Array.isArray(response.errors)) {
                                // Assume 'errors' is an array of objects {field: 'field_name', message: 'error message'}
                                response.errors.forEach(error => {
                                    const fieldName = error.field;
                                    const message = `* ${error.message}`;
                                    
                                    // Try to place the error message in the designated span (e.g., #error-head_name)
                                    const $errorSpan = $(`#error-${fieldName}`);
                                    if ($errorSpan.length) {
                                        $errorSpan.text(message);
                                    } else if (generalErrorSpan) {
                                        // Fallback to general error span
                                        generalErrorSpan.textContent += message + ' ';
                                    }
                                });
                                return; // Prevent the final 'alert'
                            } else if (typeof response.message === 'string') {
                                // If Django sends a 400 with a single 'message' key
                                generalErrorSpan.textContent = `Error: ${response.message}`;
                                return;
                            }
                        }
                        
                        // 3. Final fallback alert for unhandled errors (500, etc.)
                        const defaultError = xhr.status === 0 ? "Network connection failed. Please check your internet." : 
                                             `An unexpected server error occurred (Status: ${xhr.status}). Please try again.`;
                        alert(defaultError);
                    }
                });
            }
        });
        
        // 9. Apply rules to existing members on page load
        document.querySelectorAll(".member-block").forEach(block => {
            const index = $(block).data('member-index');
            applyMemberRules(block, index);
        });

        // 10. Custom Handlers for Conditional Fields and Re-validation
        $('input[name="head_marital_status"]').change(function() {
            $('#wedding_date_row').toggle(this.value === 'Married');
            // Re-validate the wedding date when marital status changes
            validator.element('#head_wedding_date');
        });

        $(document).on('change', 'input[name^="member_"][name$="_marital_status"]', function() {
            const index = $(this).closest('.member-block').data('member-index');
            $(`#member_${index}_wedding_date_row`).toggle(this.value === 'Married');
            // Re-validate the member wedding date
            validator.element(`input[name="member_${index}_wedding_date"]`);
        });

        // 11. AJAX for State/City (Original logic retained)
        $("#head_state").change(function() {
            var stateId = $(this).val();
            $("#head_city").empty().append('<option value="">Select City</option>');
            if (stateId) {
                $.ajax({
                    url: "/city/",
                    data: { "state_id": stateId },
                    success: function(data) {
                        $.each(data, function(index, city) {
                            $("#head_city").append('<option value="' + city.id + '">' + city.name + '</option>');
                        });
                        // Re-validate city after populating options
                        validator.element("#head_city");
                    }
                });
            } else {
                 validator.element("#head_city");
            }
        });
        
        // 12. Mobile unique check (Original logic for server communication retained)
        $('#head_mobile').on('blur', function() {
            var mobile = $(this).val().trim();
            $('#error-head_mobile_unique').text(''); // Clear previous server error
            if (mobile.length === 10 && /^\d{10}$/.test(mobile)) {
                $.get('/fims/check_head_mobile_unique/', { mobile: mobile }, function(data) {
                    if (data.exists) {
                        // This error message is for a specific server-side check before final submission
                        $('#error-head_mobile_unique').text('This mobile number is already registered.');
                    }
                });
            }
        });
        
    });

    // --- START: Dynamic DOM Management (Retained/Modified) ---

    // Function to add a hobby input
    window.addHobby = function(type, btn) {
        let section;
        let name;
        if (type === 'head') {
            section = document.getElementById("hobbies-section");
            name = 'head_hobbies[]';
        } else {
            section = btn.closest('.hobbies-section');
            const index = $(btn).closest('.member-block').data('member-index');
            name = `member_${index}_hobbies[]`;
        }
        
        const input = document.createElement("input");
        input.type = "text";
        input.name = name;
        input.placeholder = "Enter a hobby";
        input.classList.add("hobby-input");
        section.insertBefore(input, btn);
        
        // Add the validation rules for the new hobby input
        $(input).rules("add", {
            atLeastOneHobby: true
        });
        
        // Remove the hidden input if it exists and a real one is added
        if (type === 'head') {
            const hiddenInput = $('#hobbies-section').find('input[type="hidden"][name="head_hobbies[]"]');
            if (hiddenInput.length) hiddenInput.remove();
        }
    };


    window.addMember = function() {
        memberIndex++;
        const container = document.getElementById("members-container");
        
        if (document.querySelectorAll(".member-block").length > 0) {
             const hr = document.createElement("hr");
             hr.style.margin = "2em 0";
             hr.style.borderTop = "2px solid #ccc";
             container.appendChild(hr);
        }

        const newMemberBlock = document.createElement("div");
        newMemberBlock.className = "member-block";
        newMemberBlock.style.border = "1px solid #bdbdbd";
        newMemberBlock.style.borderRadius = "8px";
        newMemberBlock.style.marginBottom = "2em";
        newMemberBlock.style.background = "#f9f9f9";
        newMemberBlock.style.boxShadow = "0 2px 8px #ececec";
        newMemberBlock.setAttribute('data-member-index', memberIndex);

        newMemberBlock.innerHTML = `
            <div class="member-block-header" style="display: flex; align-items: center; justify-content: space-between; background: #e3e3e3; border-radius: 8px 8px 0 0; padding: 0.5em 1em;">
                <span class="member-title" style="font-weight: bold; font-size: 1.1em;">Member ${memberIndex}</span>
                <button type="button" class="close-member-btn" onclick="removeMember(this)" style="background: none; border: none; font-size: 1.5em; color: #b71c1c; cursor: pointer;">×</button>
            </div>
            <table class="form-table two-column" style="margin-top: 0;">
                <tr>
                    <td>
                        <label>First Name:</label>
                        <input type="text" name="member_${memberIndex}_name" placeholder="First Name" maxlength="50">
                        <span class="error-message" id="error-member_${memberIndex}_name"></span>
                    </td>
                    <td>
                        <label>Surname:</label>
                        <input type="text" name="member_${memberIndex}_surname" placeholder="Surname" maxlength="50">
                        <span class="error-message" id="error-member_${memberIndex}_surname"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Marital Status:</label>
                        <div id="member_${memberIndex}_marital_status_group">
                            <label><input type="radio" name="member_${memberIndex}_marital_status" value="Married"> Married</label>
                            <label><input type="radio" name="member_${memberIndex}_marital_status" value="Unmarried"> Unmarried</label>
                        </div>
                        <span class="error-message" id="error-member_${memberIndex}_marital_status"></span>
                    </td>
                    <td>
                        <label>Gender:</label>
                        <select name="member_${memberIndex}_gender">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                        <span class="error-message" id="error-member_${memberIndex}_gender"></span>
                    </td>
                </tr>
                <tr id="member_${memberIndex}_wedding_date_row" style="display:none;">
                    <td colspan="2">
                        <label>Wedding Date:</label>
                        <input type="date" name="member_${memberIndex}_wedding_date">
                        <span class="error-message" id="error-member_${memberIndex}_wedding_date"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Birthdate:</label>
                        <input type="date" name="member_${memberIndex}_birthdate">
                        <span class="error-message" id="error-member_${memberIndex}_birthdate"></span>
                    </td>
                    <td>
                        <label>Mobile No (optional):</label>
                        <input type="text" name="member_${memberIndex}_mobile" maxlength="10">
                        <span class="error-message" id="error-member_${memberIndex}_mobile"></span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Education:</label>
                        <select name="member_${memberIndex}_education">
                            <option value="">Select</option>
                            <option value="Graduate">Graduate</option>
                            <option value="Post Graduate">Post Graduate</option>
                            <option value="Diploma">Diploma</option>
                        </select>
                        <span class="error-message" id="error-member_${memberIndex}_education"></span>
                    </td>
                    <td>
                        <label>Upload Photo:</label>
                        <input type="file" name="member_${memberIndex}_photo" accept="image/png, image/jpeg">
                        <span class="error-message" id="error-member_${memberIndex}_photo"></span>
                    </td>
                </tr>
                 <tr>
                    <td colspan="2">
                        <label>Relationship to Head:</label>
                        <select name="member_${memberIndex}_relationship">
                            <option value="">Select</option>
                            <option value="Father">Father</option>
                            <option value="Mother">Mother</option>
                            <option value="Brother">Brother</option>
                            <option value="Sister">Sister</option>
                            <option value="Son">Son</option>
                            <option value="Daughter">Daughter</option>
                            <option value="Uncle">Uncle</option>
                            <option value="Aunt">Aunt</option>
                            <option value="Other">Other</option>
                        </select>
                        <span class="error-message" id="error-member_${memberIndex}_relationship"></span>
                    </td>
                </tr>
            </table>
        `;
        container.appendChild(newMemberBlock);
        
        // CRUCIAL: Apply validation rules to the newly added member fields
        applyMemberRules(newMemberBlock, memberIndex);
    };

    window.removeMember = function(btn) {
        const $memberBlock = $(btn).closest('.member-block');
        
        const prevElement = $memberBlock.prev();
        if (prevElement.is('hr')) {
            prevElement.remove();
        }
        
        // Remove rules for the fields within the block before removing the block
        $memberBlock.find(':input').each(function() {
            $(this).rules("remove");
        });
        
        $memberBlock.remove();
        reIndexMembers();
    };

    function reIndexMembers() {
        const memberBlocks = document.querySelectorAll(".member-block");
        memberIndex = 0;
        memberBlocks.forEach((block, index) => {
            memberIndex = index + 1;
            const $block = $(block);
            $block.data('member-index', memberIndex);
            block.querySelector('.member-title').textContent = `Member ${memberIndex}`;
            
            // Check for and remove the leading HR if this is the first block after re-indexing
            if (index === 0) {
                 const prevElement = block.previousElementSibling;
                 if (prevElement && prevElement.tagName === 'HR' && prevElement.style.borderTop === '2px solid rgb(204, 204, 204)') {
                     prevElement.remove();
                 }
            }
            
            const inputs = block.querySelectorAll('[name]');
            inputs.forEach(input => {
                const oldName = input.name;
                const newName = oldName.replace(/member_\d+_/g, `member_${memberIndex}_`);
                
                // If the name changed, remove the old rules and add the new ones
                if (oldName !== newName) {
                    const $input = $(input);
                    // Remove rules associated with the old name
                    $input.rules("remove"); 
                    
                    input.name = newName;
                    
                    // Reapply rules based on the new index
                    if (newName.startsWith(`member_${memberIndex}_`)) {
                        applyMemberRules(block, memberIndex); 
                    }
                }
            });

            // Update structural IDs (like wedding date row and error spans)
            const weddingRow = block.querySelector('[id^="member_"][id$="_wedding_date_row"]');
            if (weddingRow) {
                weddingRow.id = `member_${memberIndex}_wedding_date_row`;
            }
            
            block.querySelectorAll('[id^="error-member_"]').forEach(errorSpan => {
                // Ensure error span IDs are re-indexed correctly
                const oldId = errorSpan.id;
                const newId = oldId.replace(/error-member_\d+_/g, `error-member_${memberIndex}_`);
                errorSpan.id = newId;
            });
            block.querySelectorAll('[id^="member_"][id$="_marital_status_group"]').forEach(group => {
                group.id = `member_${memberIndex}_marital_status_group`;
            });

        });
        
        // Final memberIndex update
        memberIndex = memberBlocks.length;
    }

   
</script>
{% endblock %}
{% endblock %}